name: ğŸ“Š Bundle Size Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  bundle-analysis:
    name: ğŸ“¦ Bundle Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build for Production
        run: |
          pnpm build
        env:
          NODE_ENV: production
          BUNDLE_ANALYZE: true

      - name: ğŸ“Š Analyze Bundle
        run: |
          echo "ğŸ“¦ Bundle Analysis Results:"
          echo "================================"
          
          # Check for .next folder
          if [ -d ".next" ]; then
            # Show main bundle sizes
            echo "ğŸ¯ Main Bundle Files:"
            find .next -name "*.js" -type f | head -10 | while read file; do
              size=$(wc -c < "$file")
              echo "   $(basename "$file"): ${size} bytes"
            done
            
            echo ""
            echo "ğŸ“Š Pages Bundle Sizes:"
            find .next/static/chunks/pages -name "*.js" -type f 2>/dev/null | head -5 | while read file; do
              size=$(wc -c < "$file")
              echo "   $(basename "$file"): ${size} bytes"
            done
            
            echo ""
            echo "âš ï¸  Large Files (>500KB):"
            find .next -name "*.js" -type f -size +500k 2>/dev/null | while read file; do
              size=$(wc -c < "$file")
              echo "   â— $(basename "$file"): ${size} bytes"
            done
          else
            echo "âŒ .next folder not found - build may have failed"
          fi

      - name: ğŸš¨ Bundle Size Check
        run: |
          # Fail if any single file is over 1MB
          large_files=$(find .next -name "*.js" -type f -size +1M 2>/dev/null | wc -l)
          
          if [ "$large_files" -gt 0 ]; then
            echo "ğŸš¨ WARNING: Found $large_files files larger than 1MB"
            echo "ğŸ“‹ Consider:"
            echo "   - Code splitting"
            echo "   - Dynamic imports"
            echo "   - Tree shaking optimization"
            echo "   - Removing unused dependencies"
            exit 1
          else
            echo "âœ… All bundle files are within acceptable size limits"
          fi
