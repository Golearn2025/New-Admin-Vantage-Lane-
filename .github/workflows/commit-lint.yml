name: ğŸ“ Commit Message Lint

on:
  push:
    branches: [ main, develop, 'Ver-*' ]
  pull_request:
    branches: [ main ]

jobs:
  commitlint:
    name: ğŸ“‹ Commit Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.19'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“ Lint Commit Messages
        run: |
          echo "ğŸ“ Checking commit message format..."
          echo "Expected format: type(scope): subject"
          echo "Examples:"
          echo "  âœ… feat(auth): add login functionality"
          echo "  âœ… fix(ui): resolve button styling issue"  
          echo "  âœ… docs: update README with new instructions"
          echo "  âŒ fixed bug"
          echo "  âŒ Added new feature"
          echo ""
          
          # Get the commit range for PR or single commit for push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PR, check all commits in the PR
            COMMIT_RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          else
            # For push, check the last commit
            COMMIT_RANGE="HEAD~1..HEAD"
          fi
          
          echo "ğŸ” Checking commits in range: $COMMIT_RANGE"
          
          # Check each commit message
          git log --format="%H %s" $COMMIT_RANGE | while read commit_hash commit_message; do
            echo "ğŸ“‹ Checking: $commit_message"
            
            # Check conventional commit format: type(scope): subject
            if echo "$commit_message" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|ci|perf|build|revert)(\(.+\))?: .+'; then
              echo "âœ… Valid: $commit_message"
            else
              echo "âŒ Invalid commit message: $commit_message"
              echo ""
              echo "ğŸš¨ Commit message must follow conventional commits format:"
              echo "   type(scope): subject"
              echo ""
              echo "ğŸ“‹ Valid types:"
              echo "   feat: new feature"
              echo "   fix: bug fix" 
              echo "   docs: documentation"
              echo "   style: formatting, missing semicolons"
              echo "   refactor: code refactoring"
              echo "   test: adding tests"
              echo "   chore: maintenance tasks"
              echo "   ci: CI/CD changes"
              echo "   perf: performance improvements"
              echo "   build: build system changes"
              echo "   revert: reverting changes"
              echo ""
              echo "ğŸ“‹ Examples:"
              echo "   feat(auth): add OAuth integration"
              echo "   fix(ui-core): resolve table header styling"
              echo "   docs: update installation guide"
              echo "   refactor(api): extract user service"
              echo ""
              exit 1
            fi
          done

      - name: âœ… Success
        run: |
          echo "ğŸ‰ All commit messages follow conventional commits format!"
          echo "ğŸ“‹ Great job maintaining clean git history!"
